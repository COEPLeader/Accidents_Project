---
title: 'US Accidents (2016-2021) or: What the hell is going on in California?'
author: "Seth Buesing, Jason Whitelaw, Kai Yamanishi"
output: 
  html_document:
    keep_md: TRUE
    toc: TRUE
    toc_float: TRUE
    df_print: paged
    code_download: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error=TRUE, message=FALSE, warning=FALSE)
```

```{r libraries}
library(tidyverse)
library(lubridate)
library(openintro)
library(maps)
library(ggmap)
library(gplots)
library(RColorBrewer)
library(sf)
library(leaflet)
library(ggthemes)
library(gganimate)
library(gifski)
library(transformr)
library(osmdata)
library(reticulate)
theme_set(theme_minimal())
```

```{r, cache = TRUE}
accidents_data <- read_csv("US_Accidents_Dec21_updated.csv")
states_map <- map_data("state")
```

```{r, cache = TRUE}
accidents_clean <- accidents_data %>%
  mutate(state = state.name[match(State, state.abb)]) %>%
  mutate(state = str_to_lower(state)) %>%
  filter(is.na(state)==FALSE) %>%
  mutate(year = substring(Start_Time, 0, 4))
```  

```{r, cache = TRUE}
accidents_ca <- accidents_clean %>%
  filter(State == "CA")
```

#Introduction
  In our search for an interesting dataset to analyze we came across a wonderfully organized table detailing traffic accidents in the contiguous United States over the last 5 years. What caught our interest in specific was looking at the evolution over time of crash statistics in specific states- most notably California. As the graph below shows, the number of accidents in California has been doubling each year, and we wanted to figure out just what was happening. The dataset we're working with is extraordinarily large, containing over 2.8 million accidents taken from automated traffic sensors and logged reports. Each accident has 47 columns of information.

```{r, cache = TRUE, eval=FALSE}
accidents_clean %>%
  group_by(state, year) %>%
  mutate(num_accidents = n()) %>%
  select(state, year, num_accidents) %>%
  unique() %>%
  arrange(year) %>%
  ungroup() %>%
  add_row(year = "2017", state = "north dakota", num_accidents = 0) %>%
  ggplot() +
  geom_map(map = states_map, aes(map_id = state, fill = num_accidents, group = year)) +
  expand_limits(x = states_map$long, y = states_map$lat) + 
  theme_map() +
  labs(title = "Number of Car Accidents by State, 2016-2021", subtitle = "Year: {closest_state}", fill = "Number of Accidents") +
  transition_states(year)
```

```{r, cache = TRUE}
anim_save("accidents.gif")
knitr::include_graphics("accidents.gif")
```

#Data Collection
  Our Data Collection process was pretty simple- we found the data set on [https://www.kaggle.com/datasets/sobhanmoosavi/us-accidents]() and downloaded the csv file. We did run into some issues using this csv, however due to its sheer size (1.1 GB).

#Analysis

So, what would cause this pattern? The dataset we found had columns for factors such as whether the accident was in the day or the night, what the temperature and weather were like, and the type of accident. Time of day is a big factor in how often accidents occur, even though that effect is mitigated by the fact that fewer people are driving later in the day. We decided to look at the proportion of day to night accidents, still not expecting too much of a correlation.

```{r, cache = TRUE}
accidents_ca %>%
  filter(is.na(Sunrise_Sunset)==FALSE) %>%
  group_by(year) %>%
  mutate(num_accidents = n()) %>%
  ungroup() %>%
  group_by(year, Sunrise_Sunset) %>%
  mutate(percent_day_night = n()/num_accidents) %>%
  ungroup() %>%
  select(percent_day_night, year, Sunrise_Sunset) %>%
  unique() %>%
  ggplot() +
  geom_col(aes(x = year, y = percent_day_night, fill = Sunrise_Sunset)) +
  labs(title = "Percent of Day/Night Accidents in California by Year", fill = "Time of Day", y = "Year") +
  ylab("")
```

Oddly enough, we do see an increase in the proportion of night accidents over the last 3 years. 

```{r, cache = TRUE}
accidents_ca %>%
  filter(is.na(Weather_Condition)==FALSE) %>%
  group_by(year) %>%
  mutate(num_accidents = n()) %>%
  ungroup() %>%
  group_by(year, Weather_Condition) %>%
  mutate(percent_weather = n()/num_accidents) %>%
  filter(percent_weather>.01) %>%
  ungroup() %>%
  select(percent_weather, year, Weather_Condition) %>%
  unique() %>%
  group_by(year) %>%
  mutate(other = 1-sum(percent_weather)) %>%
  ungroup() %>%
  add_row(year = "2016", Weather_Condition = "Other", percent_weather = 0.02103897) %>%
  add_row(year = "2017", Weather_Condition = "Other", percent_weather = 0.02290385) %>%
  add_row(year = "2018", Weather_Condition = "Other", percent_weather = 0.02343750) %>%
  add_row(year = "2019", Weather_Condition = "Other", percent_weather = 0.03828895) %>%
  add_row(year = "2020", Weather_Condition = "Other", percent_weather = 0.03021382) %>%
  add_row(year = "2021", Weather_Condition = "Other", percent_weather = 0.03736665) %>%
  ggplot() +
  geom_col(aes(x = "", y = percent_weather, fill = Weather_Condition)) +
  coord_polar("y", start = 0) +
  facet_wrap(vars(year)) +
  labs(title = "Types of Weather During Accidents in California by Year", fill = "Weather") +
  theme_void()
```

  
```{r, cache = TRUE}
big_streets <- opq(bbox = c(-118.965,33.6818,-117.3367,34.4395), timeout = 100)%>%
  add_osm_feature(key = "highway", 
                  value = c("motorway", "primary", "motorway_link", "primary_link")) %>%
  osmdata_sf()
```

```{r}
  accidents_data_LA <- accidents_data %>% 
    filter((Start_Lng >= -118.9655) & (Start_Lng <= -117.3367) & (Start_Lat >= 33.6818) & (Start_Lat <= 34.4395))

  accidents_data_LA_points <- accidents_data_LA %>% 
    select(Start_Lat:End_Lng)
```

```{r}
  LA_map <- get_stamenmap(
     bbox = c(left = -118.9655 , bottom = 33.6818, right = -117.3367, top = 34.4395), 
     maptype = "toner-lite",
     zoom = 9)
```

```{r, eval = FALSE}
  LA_bigstreets <- ggmap(LA_map) +
    geom_point(data = accidents_data_LA_points, 
               aes(x = Start_Lng,
                   y = Start_Lat),
               size = .1,
               alpha = .1,
               color = "red") +
  labs(x = NULL,
       y = NULL)
  geom_sf(data = big_streets$osm_lines,
          inherit.aes = FALSE,
          color = "green",
          size = .1,
          alpha = .9) +
    theme_map() +
    theme(axis.text.x = "none",
          axis.text.y = "none")
  
  ggsave(filename = "images/LA_bigstreets.png", LA_bigstreets)
```

```{r}
  knitr::include_graphics("images/LA_bigstreets.png")
```

